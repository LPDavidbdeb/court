<script>
document.addEventListener('DOMContentLoaded', function () {
    const nodeModal = new bootstrap.Modal(document.getElementById('nodeModal'));
    const modalForm = document.getElementById('nodeForm');
    const modalLabel = document.getElementById('nodeModalLabel');
    const saveBtn = document.getElementById('saveNodeBtn');
    
    let currentActionUrl = '';
    let currentMethod = 'POST';

    // --- Event Listeners for Buttons ---

    document.getElementById('tree-container').addEventListener('click', function(e) {
        const target = e.target.closest('.btn-add, .btn-edit, .btn-delete');
        if (!target) return;

        const nodeId = target.dataset.nodeId;

        if (target.classList.contains('btn-add')) {
            setupAddModal(nodeId);
        } else if (target.classList.contains('btn-edit')) {
            setupEditModal(nodeId);
        } else if (target.classList.contains('btn-delete')) {
            handleDelete(nodeId);
        }
    });

    // --- Modal Setup Functions ---

    function setupAddModal(nodeId) {
        modalLabel.textContent = 'Add New Child Node';
        currentActionUrl = `{% url 'document_manager:ajax_add_node' 0 %}`.replace('0', nodeId);
        currentMethod = 'POST';
        modalForm.reset();
        nodeModal.show();
    }

    function setupEditModal(nodeId) {
        modalLabel.textContent = 'Edit Node';
        currentActionUrl = `{% url 'document_manager:ajax_edit_node' 0 %}`.replace('0', nodeId);
        currentMethod = 'POST'; // We will use POST for update
        
        // Fetch current node data to populate the form
        fetch(currentActionUrl, { method: 'GET', headers: {'X-CSRFToken': getCsrfToken()} })
            .then(response => response.json())
            .then(data => {
                modalForm.querySelector('#id_item').value = data.item;
                modalForm.querySelector('#id_text').value = data.text;
                nodeModal.show();
            });
    }

    // --- Action Handlers ---

    saveBtn.addEventListener('click', function() {
        const formData = new FormData(modalForm);
        
        fetch(currentActionUrl, {
            method: currentMethod,
            body: formData,
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                nodeModal.hide();
                // Simple reload to see changes. A more advanced implementation
                // would dynamically insert/update the node in the DOM.
                location.reload(); 
            } else {
                // Handle errors (e.g., display them in the modal)
                alert('Error: ' + data.message);
                console.error(data.errors);
            }
        });
    });

    function handleDelete(nodeId) {
        if (!confirm('Are you sure you want to delete this node and all its children?')) {
            return;
        }
        
        const deleteUrl = `{% url 'document_manager:ajax_delete_node' 0 %}`.replace('0', nodeId);
        
        fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById(`node-${nodeId}`).remove();
            } else {
                alert('Error: ' + data.message);
            }
        });
    }

    // --- Utility ---

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
});
</script>
