{% extends "base.html" %}
{% load document_extras %}

{% block title %}{{ document.title }} - The Truth{% endblock %}

{% block extra_head %}
<style>
    /* ... previous styles ... */

    /* Small tweak for the Left Pane Header */
    .cluster-meta {
        border-bottom: 1px solid #333;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}

<div class="cinematic-wrapper">
    </div>

<div class="confrontation-wrapper">
    <div class="text-center text-white py-5">
        <h3>ANALYSE CONTRADICTOIRE</h3>
        <p class="text-muted">Regroupement par grappes factuelles</p>
        <i class="fas fa-chevron-down text-white"></i>
    </div>

    {% for block in confrontation_blocks %}
    <div class="confrontation-block">

        <div class="pane-allegation">
            <div class="cluster-meta">
                <small class="text-danger text-uppercase">
                    <i class="fas fa-layer-group"></i> Grappe #{{ forloop.counter }}
                </small>
                <div class="text-muted small mt-1">
                    Ciblé par {{ block.narrative_count }} Trame(s) Narrative(s)
                </div>
            </div>

            <blockquote class="blockquote">
                {% for stmt in block.statements %}
                    <div class="mb-4">
                        {% if stmt.numbering %}
                            <strong class="text-danger me-2">{{ stmt.numbering }}</strong>
                        {% endif %}
                        <span>"{{ stmt.text }}"</span>
                    </div>
                {% endfor %}
            </blockquote>

            <div class="text-muted small border-top pt-3 mt-auto" style="border-color: #333 !important;">
                Status: <span class="text-danger">RÉFUTÉE</span><br>
                Éléments de preuve cumulés: {{ block.evidence|length }}
            </div>
        </div>

        <div class="pane-evidence">

            <div class="mb-4">
                {% for title in block.narrative_titles %}
                    <span class="badge bg-secondary mb-1">{{ title }}</span>
                {% endfor %}
            </div>

            {% for item in block.evidence %}
                <div class="evidence-card">
                    <div class="evidence-date">
                        <i class="far fa-calendar-alt"></i>
                        {{ item.date|date:"d F Y"|default:"Date Inconnue" }}
                    </div>

                    <h5>{{ item.source_title }}</h5>
                    <p class="mt-3">{{ item.content|truncatechars:300 }}</p>

                    {% if item.type == 'email' %}
                        <span class="badge bg-primary"><i class="fas fa-envelope"></i> Courriel</span>
                    {% elif item.type == 'pdf' %}
                        <span class="badge bg-danger"><i class="fas fa-file-pdf"></i> Document</span>
                    {% elif item.type == 'event' %}
                        <span class="badge bg-success"><i class="fas fa-calendar-check"></i> Événement</span>
                    {% elif item.type == 'photo' %}
                        <span class="badge bg-info"><i class="fas fa-camera"></i> Photo</span>
                    {% endif %}

                    <div class="evidence-source">
                        Source: {{ item.author_name }}
                    </div>
                </div>
            {% empty %}
                <div class="alert alert-warning">
                    Aucune preuve liée (erreur de configuration).
                </div>
            {% endfor %}

            <div style="height: 20vh;"></div>
        </div>
    </div>
    {% empty %}
        <div class="text-center text-white py-5">
            <p>Aucun regroupement narratif trouvé pour ce document.</p>
        </div>
    {% endfor %}

    <div class="text-center text-white py-5" style="height: 50vh; display: flex; align-items: center; justify-content: center;">
        <h1>FIN DE L'ANALYSE</h1>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{% endblock %}