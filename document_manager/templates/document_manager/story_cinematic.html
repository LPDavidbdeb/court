{% extends "base.html" %}
{% load document_extras %}

{% block title %}{{ document.title }} - The Truth{% endblock %}

{% block extra_head %}
<style>
    /* --- CORE VARIABLES --- */
    :root {
        --cine-bg-color: 255, 255, 255; /* Starts White */
    }

    body {
        /* The background color is dynamic controlled by JS */
        background-color: rgb(var(--cine-bg-color)) !important;
        transition: background-color 0.1s linear;
        overflow-x: hidden;
        margin: 0;
    }

    /* --- PHASE 1 & 2: CINEMATIC SCROLL --- */
    .cinematic-wrapper {
        max-width: 800px;
        margin: 0 auto;
        padding-bottom: 100px;
        font-family: 'Georgia', serif;
    }

    /* 1. Reading Context */
    .document-context {
        padding-top: 50px;
        margin-bottom: 20vh;
    }

    .context-node {
        margin-bottom: 1.5rem;
        /* Text is BLACK. Disappears when bg turns BLACK. */
        color: rgb(0, 0, 0);
        transition: opacity 0.5s ease;
    }

    /* 2. Transition Zone (The Spacer) */
    .transition-zone {
        height: 50vh;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        pointer-events: none;
        color: #aaa;
    }

    .fade-instruction {
        font-style: italic;
        opacity: 1;
        transition: opacity 0.5s;
    }

    /* 3. The Revelation List (Intermediate step) */
    .revelation-list {
        min-height: 80vh;
        padding-top: 50px;
    }

    .revelation-node {
        margin-bottom: 2rem;
        padding-left: 20px;
        border-left: 4px solid #dc3545; /* Red marker */
        color: #fff; /* Visible on Black */
    }

    /* --- PHASE 3: THE CONFRONTATION (Split Screen) --- */

    /* Mobile Fallback */
    .confrontation-wrapper {
        display: block;
        background-color: #000; /* Pure black base */
        padding-bottom: 20vh;
    }

    /* Desktop Grid */
    @media (min-width: 992px) {
        .confrontation-block {
            display: flex;
            min-height: 100vh;
            border-top: 1px solid #333;
        }

        /* LEFT PANE: Sticky Allegation */
        .pane-allegation {
            width: 40%;
            background-color: #000;
            color: #fff;
            padding: 4rem;
            position: sticky;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 1px solid #333;
        }

        /* RIGHT PANE: Scrolling Evidence */
        .pane-evidence {
            width: 60%;
            background-color: #f8f9fa;
            color: #000;
            padding: 4rem;
        }

        /* Evidence Cards */
        .evidence-card {
            background: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 40px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            transition: transform 0.3s;
        }

        .evidence-card:hover {
            transform: translateY(-5px);
            border-left: 5px solid #28a745;
        }

        .evidence-date {
            font-weight: bold;
            color: #28a745;
            text-transform: uppercase;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        .evidence-source {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 1rem;
            border-top: 1px solid #eee;
            padding-top: 0.5rem;
        }
    }

    /* Meta Header for Cluster */
    .cluster-meta {
        border-bottom: 1px solid #333;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}

<div class="cinematic-wrapper">

    <div class="document-context">
        <div class="text-center mb-5">
            <h1 class="display-4">{{ document.title }}</h1>
            <p class="text-muted">Source: {{ document.get_source_type_display }}</p>
            <hr>
        </div>

        {% for node in nodes %}
            {% if node.content_object.text %}
                <div class="context-node" style="margin-left: {{ node.indent_pixels }}px;">
                    <p>
                        {% if node.numbering %}<strong>{{ node.numbering }}</strong>{% endif %}
                        {{ node.content_object.text }}
                    </p>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="transition-zone" id="fade-trigger">
        <div class="fade-instruction">
            <i class="fas fa-arrow-down"></i><br>
            Continuer pour isoler les faux énoncés...
        </div>
    </div>

    <div class="revelation-list">
        <h2 class="text-danger mb-5 text-center">Énoncés Identifiés Faux</h2>

        {% for node in nodes %}
            {% if not node.content_object.is_true and node.content_object.is_falsifiable %}
                <div class="revelation-node">
                    <p class="mb-1">
                        {% if node.numbering %}<strong>{{ node.numbering }}</strong>{% endif %}
                        {{ node.content_object.text }}
                    </p>
                </div>
            {% endif %}
        {% endfor %}
    </div>

</div>

<div class="confrontation-wrapper">
    <div class="text-center text-white py-5">
        <h3>ANALYSE CONTRADICTOIRE</h3>
        <p class="text-muted">Regroupement par Contestations</p>
        <i class="fas fa-chevron-down text-white"></i>
    </div>

    {% for block in confrontation_blocks %}
    <div class="confrontation-block">

        <div class="pane-allegation">
            <div class="cluster-meta">
                <small class="text-danger text-uppercase">
                    <i class="fas fa-gavel"></i> Contestation #{{ forloop.counter }}
                </small>
                <h4 class="text-white mt-2">{{ block.title }}</h4>
                <div class="text-muted small">
                    Dossier: {{ block.case_title }}
                </div>
            </div>

            <blockquote class="blockquote">
                {% for stmt in block.statements %}
                    <div class="mb-4">
                        {% if stmt.numbering %}
                            <strong class="text-danger me-2">{{ stmt.numbering }}</strong>
                        {% endif %}
                        <span>"{{ stmt.text }}"</span>
                    </div>
                {% endfor %}
            </blockquote>

            <div class="text-muted small border-top pt-3 mt-auto" style="border-color: #333 !important;">
                Status: <span class="text-danger">RÉFUTÉE</span><br>
                Éléments de preuve cumulés: {{ block.evidence|length }}
            </div>
        </div>

        <div class="pane-evidence">

            <div class="mb-4">
                {% for title in block.narrative_titles %}
                    <span class="badge bg-secondary mb-1">{{ title }}</span>
                {% endfor %}
            </div>

            {% for item in block.evidence %}
                <div class="evidence-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="evidence-date">
                            <i class="far fa-calendar-alt"></i>
                            {{ item.date|date:"d F Y"|default:"Date Inconnue" }}
                        </div>

                        {% if item.exhibit_label %}
                            <span class="badge bg-dark border border-white">
                                Pièce {{ item.exhibit_label }}
                            </span>
                        {% endif %}
                    </div>

                    <h5 class="mt-2">{{ item.source_title }}</h5>
                    <p class="mt-3">{{ item.content|truncatechars:300 }}</p>

                    {% if item.type == 'email' %}
                        <span class="badge bg-primary"><i class="fas fa-envelope"></i> Courriel</span>
                    {% elif item.type == 'pdf' %}
                        <span class="badge bg-danger"><i class="fas fa-file-pdf"></i> Document</span>
                    {% elif item.type == 'event' %}
                        <span class="badge bg-success"><i class="fas fa-calendar-check"></i> Événement</span>
                    {% elif item.type == 'photo' %}
                        <span class="badge bg-info"><i class="fas fa-camera"></i> Photo</span>
                    {% endif %}

                    <div class="evidence-source">
                        Source: {{ item.author_name }}
                    </div>
                </div>
            {% empty %}
                <div class="alert alert-warning">
                    Aucune preuve liée (erreur de configuration).
                </div>
            {% endfor %}

            <div style="height: 20vh;"></div>
        </div>
    </div>
    {% empty %}
        <div class="text-center text-white py-5">
            <p>Aucun regroupement narratif trouvé pour ce document.</p>
        </div>
    {% endfor %}

    <div class="text-center text-white py-5" style="height: 50vh; display: flex; align-items: center; justify-content: center;">
        <h1>FIN DE L'ANALYSE</h1>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const triggerZone = document.getElementById('fade-trigger');
        const instruction = document.querySelector('.fade-instruction');
        const contextNodes = document.querySelectorAll('.context-node');

        // Colors
        const startColor = [255, 255, 255]; // White
        const endColor = [0, 0, 0];         // Black

        if (triggerZone) {
            window.addEventListener('scroll', function() {
                const rect = triggerZone.getBoundingClientRect();
                const windowHeight = window.innerHeight;

                let progress = 0;

                // Tune these for how fast the fade happens
                const startFade = windowHeight;
                const endFade = windowHeight * 0.2;

                if (rect.top <= startFade) {
                    const distance = startFade - rect.top;
                    const totalDistance = startFade - endFade;
                    progress = Math.min(Math.max(distance / totalDistance, 0), 1);
                }

                // 1. Interpolate Background
                const currentBg = interpolateColor(startColor, endColor, progress);
                document.documentElement.style.setProperty('--cine-bg-color', `${currentBg.join(',')}`);

                // 2. Hide instruction text
                if (instruction) {
                    instruction.style.opacity = (progress > 0.5) ? '0' : '1';
                }

                // 3. Fade out the reading context (Phase 1)
                contextNodes.forEach(node => {
                    node.style.opacity = Math.max(1 - (progress * 1.5), 0);
                });
            });
        }

        // Helper to mix colors
        function interpolateColor(color1, color2, factor) {
            var result = color1.slice();
            for (var i = 0; i < 3; i++) {
                result[i] = Math.round(result[i] + factor * (color2[i] - color1[i]));
            }
            return result;
        }
    });
</script>
{% endblock %}