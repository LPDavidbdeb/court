{% extends 'base.html' %}

{% block title %}Photo List{% endblock %}

{% block content %}
<form action="{% url 'photos:bulk_delete' %}" method="post" id="bulk-delete-form">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Photo List</h1>
        <div>
            {# This button is now the primary way to add photos in bulk #}
            <a href="{% url 'photos:processing' %}" class="btn btn-primary">Batch Process Photos</a>
            <button type="submit" class="btn btn-danger">Delete Selected Photos</button>
        </div>
    </div>

    {% if photos %}
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th><input class="form-check-input" type="checkbox" id="select-all-checkbox"></th>
                        <th>Thumbnail</th>
                        <th>Filename</th>
                        <th>Type</th>
                        <th>Date Taken</th>
                        <th>Dimensions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for photo in photos %}
                        <tr>
                            <td><input class="form-check-input photo-checkbox" type="checkbox" name="photo_ids" value="{{ photo.pk }}" id="photo-{{ photo.pk }}"></td>
                            <td>
                                {% if photo.file %}
                                    <a href="{{ photo.file.url }}" target="_blank">
                                        <img src="{{ photo.file.url }}" alt="{{ photo.file_name }}" style="width: 100px; height: auto; object-fit: cover; border-radius: 0.25rem;">
                                    </a>
                                {% endif %}
                            </td>
                            <td><a href="{{ photo.get_absolute_url }}">{{ photo.file_name }}</a></td>
                            <td><span class="badge bg-info text-dark">{{ photo.photo_type.name|default:"N/A" }}</span></td>
                            <td>{{ photo.datetime_original|date:"Y-m-d H:i"|default:"N/A" }}</td>
                            <td>{% if photo.width and photo.height %}{{ photo.width }}x{{ photo.height }}{% else %}N/A{% endif %}</td>
                            <td>
                                <a href="{% url 'photos:update' pk=photo.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# Pagination Controls #}
        {% if is_paginated %}
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">Previous</span></li>
                    {% endif %}
                    {% for i in paginator.page_range %}
                        <li class="page-item {% if page_obj.number == i %}active{% endif %}"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                    {% endfor %}
                    {% if page_obj.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">Next</span></li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}

    {% else %}
        <div class="alert alert-info">No photos have been uploaded yet.</div>
    {% endif %}
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const photoCheckboxes = document.querySelectorAll('.photo-checkbox');
    const deleteForm = document.getElementById('bulk-delete-form');

    selectAllCheckbox.addEventListener('change', function() {
        photoCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    deleteForm.addEventListener('submit', function(event) {
        const checkedCount = document.querySelectorAll('.photo-checkbox:checked').length;
        if (checkedCount === 0) {
            alert('Please select at least one photo to delete.');
            event.preventDefault();
            return;
        }
        if (!confirm(`Are you sure you want to delete ${checkedCount} selected photo(s)?`)) {
            event.preventDefault();
        }
    });
});
</script>
{% endblock %}
