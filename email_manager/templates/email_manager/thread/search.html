{% extends 'base.html' %}

{% block title %}Gmail Email Search{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h1 class="h4 mb-0">Search Gmail Emails</h1>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="protagonist-search-input" class="form-label">{{ form.protagonist_search_input.label }}</label>
                        <input type="text" id="protagonist-search-input" class="form-control" name="{{ form.protagonist_search_input.html_name }}" value="{{ form.protagonist_search_input.value|default_if_none:'' }}" placeholder="Start typing name or email...">
                        <div id="protagonist-suggestions" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                        <div class="form-text">{{ form.protagonist_search_input.help_text }}</div>
                        {{ form.protagonist_id }}
                    </div>

                    <div id="email-selection-container" class="mb-3" style="display: none;">
                        <label class="form-label">Select Email for Search:</label>
                        <div id="email-radio-buttons" class="border rounded p-2"></div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.manual_participant_email.id_for_label }}" class="form-label">{{ form.manual_participant_email.label }}</label>
                        <input type="email" class="form-control" id="{{ form.manual_participant_email.id_for_label }}"
                               name="{{ form.manual_participant_email.html_name }}"
                               value="{{ form.manual_participant_email.value|default_if_none:'' }}">
                        <div class="form-text">{{ form.manual_participant_email.help_text }}</div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.date_sent.id_for_label }}" class="form-label">{{ form.date_sent.label }}</label>
                        {{ form.date_sent }}
                        <div class="form-text">{{ form.date_sent.help_text }}</div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.email_excerpt.id_for_label }}" class="form-label">{{ form.email_excerpt.label }}</label>
                        {{ form.email_excerpt }}
                        <div class="form-text">{{ form.email_excerpt.help_text }}</div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">Search Email</button>
                </form>
            </div>
        </div>

        {% if search_results %}
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h2 class="h5 mb-0">Search Results</h2>
                </div>
                <div class="card-body">
                    {% if search_results.status == 'success' and search_results.thread %}
                        <div class="alert alert-success" role="alert">
                            <strong>Success!</strong> Found a new, unsaved email thread.
                        </div>
                        
                        <div class="mt-3">
                            <h4>Thread Details</h4>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item"><strong>Subject:</strong> {{ search_results.thread.subject }}</li>
                                <li class="list-group-item"><strong>Thread ID:</strong> <span class="badge bg-secondary">{{ search_results.thread.id }}</span></li>
                                <li class="list-group-item"><strong>Number of Messages:</strong> {{ search_results.thread.messages|length }}</li>
                            </ul>
                        </div>

                        <h4 class="mt-3">First Message Preview:</h4>
                        <div class="card card-body bg-light email-body-scrollable">
                            <pre class="mb-0">{{ search_results.thread.messages.0.body_plain_text|truncatewords:100 }}</pre>
                        </div>

                        <form method="post" action="{% url 'email_manager:thread_save' %}" class="mt-3">
                            {% csrf_token %}
                            <input type="hidden" name="thread_id" value="{{ search_results.thread.id }}">
                            {% if selected_protagonist %}
                                <input type="hidden" name="protagonist_id" value="{{ selected_protagonist.pk }}">
                            {% endif %}
                            <button type="submit" class="btn btn-primary">Save This Entire Thread</button>
                        </form>

                    {% elif search_results.status == 'not_found' %}
                        <div class="alert alert-warning" role="alert">
                            {{ search_results.message }}
                        </div>
                    {% elif search_results.status == 'error' %}
                        <div class="alert alert-danger" role="alert">
                            <strong>Error:</strong> {{ search_results.message }}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_head %}
<style>
    .email-body-scrollable { max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; padding: 1rem; border-radius: .25rem; }
    .email-body-scrollable pre { font-family: monospace; font-size: 0.875em; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
    #protagonist-suggestions { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; border-top: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #protagonist-suggestions .list-group-item { cursor: pointer; }
    #protagonist-suggestions .list-group-item:hover { background-color: #f8f9fa; }
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const searchInput = $('#protagonist-search-input');
    const suggestionsBox = $('#protagonist-suggestions');
    const protagonistIdInput = $('input[name="protagonist_id"]');
    const manualEmailInput = $('#id_manual_participant_email');
    const emailSelectionContainer = $('#email-selection-container');
    const emailRadioButtons = $('#email-radio-buttons');

    searchInput.on('keyup', function() {
        const query = $(this).val();
        protagonistIdInput.val('');
        emailSelectionContainer.hide();
        emailRadioButtons.empty();
        if (query.length < 2) {
            suggestionsBox.empty().hide();
            return;
        }
        $.ajax({
            url: '{% url "protagonist_manager:search_protagonists_ajax" %}',
            data: { 'q': query },
            dataType: 'json',
            success: function(data) {
                suggestionsBox.empty();
                if (data.length > 0) {
                    $.each(data, function(index, protagonist) {
                        let emailsHtml = protagonist.emails && protagonist.emails.length > 0 ? ' (' + protagonist.emails.join(', ') + ')' : '';
                        const item = $('<a href="#" class="list-group-item list-group-item-action">')
                            .html(`<strong>${protagonist.full_name}</strong> - ${protagonist.role}${emailsHtml}`)
                            .data('protagonist', protagonist); // Store the whole object
                        suggestionsBox.append(item);
                    });
                    suggestionsBox.show();
                } else {
                    suggestionsBox.hide();
                }
            }
        });
    });

    suggestionsBox.on('click', '.list-group-item', function(e) {
        e.preventDefault();
        const protagonist = $(this).data('protagonist');
        
        searchInput.val(protagonist.full_name);
        protagonistIdInput.val(protagonist.id);
        suggestionsBox.empty().hide();
        emailSelectionContainer.hide();
        emailRadioButtons.empty();

        if (protagonist.emails && protagonist.emails.length > 0) {
            if (protagonist.emails.length === 1) {
                manualEmailInput.val(protagonist.emails[0]);
            } else {
                manualEmailInput.val('');
                $.each(protagonist.emails, function(index, email) {
                    const radioId = `email-radio-${index}`;
                    const radio = $(`
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="selected_email" id="${radioId}" value="${email}">
                            <label class="form-check-label" for="${radioId}">${email}</label>
                        </div>
                    `);
                    if (index === 0) {
                        radio.find('input').prop('checked', true);
                        manualEmailInput.val(email);
                    }
                    emailRadioButtons.append(radio);
                });
                emailSelectionContainer.show();
            }
        } else {
            manualEmailInput.val('');
        }
    });

    emailRadioButtons.on('change', 'input[name="selected_email"]', function() {
        manualEmailInput.val($(this).val());
    });

    $(document).on('click', function(e) {
        if (!$(e.target).closest('#protagonist-search-input, #protagonist-suggestions').length) {
            suggestionsBox.empty().hide();
        }
    });
});
</script>
{% endblock %}
