{% for msg in messages %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ msg.id }}">
            <button class="accordion-button {% if forloop.first and not is_reply %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ msg.id }}" aria-expanded="{% if forloop.first and not is_reply %}true{% else %}false{% endif %}" aria-controls="collapse{{ msg.id }}">
                <strong>{{ msg.headers.Subject|default:"(No Subject)" }}</strong>&nbsp;-&nbsp;<em>From: {{ msg.headers.From }}</em>&nbsp;on&nbsp;{{ msg.get_date_sent|date:"F j, Y, P" }}
            </button>
        </h2>
        <div id="collapse{{ msg.id }}" class="accordion-collapse collapse {% if forloop.first and not is_reply %}show{% endif %}" aria-labelledby="heading{{ msg.id }}" data-bs-parent="#emailThreadAccordion">
            <div class="accordion-body">
                <p><strong>To:</strong> {{ msg.headers.To }}</p>
                {% if msg.headers.Cc %}<p><strong>Cc:</strong> {{ msg.headers.Cc }}</p>{% endif %}
                <hr>
                <pre class="email-body-scrollable">{{ msg.body_plain_text|default:"(No body content available)" }}</pre>
                
                {% if msg.replies %}
                    <div class="mt-3 ps-4 border-start">
                        <h6 class="text-muted">Replies:</h6>
                        {% include "email_manager/_recursive_thread.html" with messages=msg.replies is_reply=True %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endfor %}