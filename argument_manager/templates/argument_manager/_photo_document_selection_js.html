<script>
document.addEventListener('DOMContentLoaded', function() {
    const photoDocumentsModal = document.getElementById('selectPhotoDocumentsModal');
    const photoDocumentsModalBody = document.getElementById('photo-documents-modal-body');
    const savePhotoDocumentChangesBtn = document.getElementById('save-photo-document-changes-btn');
    const photoDocumentList = document.getElementById('photo-document-list');
    const hiddenInput = document.getElementById('id_selected_photo_documents');
    const narrativeId = {{ form.instance.pk }};

    let documentsData = []; // To store fetched data

    photoDocumentsModal.addEventListener('show.bs.modal', function () {
        // Fetch the list of photo documents from the server
        fetch(`/arguments/${narrativeId}/ajax_get_photo_documents/`)
            .then(response => response.json())
            .then(data => {
                documentsData = data; // Store for later use
                let listHtml = '<ul class="list-group">';
                data.forEach(doc => {
                    listHtml += `
                        <li class="list-group-item">
                            <input class="form-check-input me-1" type="checkbox" value="${doc.id}" id="doc-${doc.id}" ${doc.is_associated ? 'checked' : ''}>
                            <label class="form-check-label" for="doc-${doc.id}">${doc.title}</label>
                        </li>
                    `;
                });
                listHtml += '</ul>';
                photoDocumentsModalBody.innerHTML = listHtml;
            })
            .catch(error => {
                console.error('Error fetching photo documents:', error);
                photoDocumentsModalBody.innerHTML = '<p class="text-danger">Could not load documents.</p>';
            });
    });

    savePhotoDocumentChangesBtn.addEventListener('click', function() {
        const selectedIds = Array.from(photoDocumentsModalBody.querySelectorAll('input[type="checkbox"]:checked'))
                                 .map(input => input.value);

        // Update the hidden input that will be submitted with the form
        hiddenInput.value = selectedIds.join(',');

        // Update the visible list on the main form
        let listHtml = '';
        selectedIds.forEach(id => {
            const doc = documentsData.find(d => d.id == id);
            if (doc) {
                listHtml += `<li class="list-group-item" data-doc-id="${doc.id}">${doc.title}</li>`;
            }
        });
        photoDocumentList.innerHTML = listHtml;

        // Close the modal
        const modal = bootstrap.Modal.getInstance(photoDocumentsModal);
        modal.hide();
    });
});
</script>
