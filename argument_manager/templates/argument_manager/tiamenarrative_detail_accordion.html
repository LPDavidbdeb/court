{% extends 'base.html' %}
{% load static %}

{% block title %}Narrative Details (Accordion View){% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h3>{{ narrative.titre }}</h3>
                <small class="text-muted">{{ narrative.get_type_argument_display }}</small>
            </div>
            <a href="{% url 'argument_manager:affidavit_generator' narrative.pk %}" class="btn btn-primary">Generate Affidavit</a>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-end mb-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="viewType" id="columnsView" value="columns">
                    <label class="form-check-label" for="columnsView">Columns</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="viewType" id="accordionView" value="accordion" checked>
                    <label class="form-check-label" for="accordionView">Accordion</label>
                </div>
            </div>

            <p><strong>Summary:</strong></p>
            <div id="summary-content" class="p-3 bg-light rounded" title="Click to edit" style="cursor:pointer;">{{ narrative.resume|safe }}</div>

            <hr>

            <div class="accordion" id="evidenceAccordion">
                
                <!-- Statements Card - NEW -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingStatements">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStatements" aria-expanded="false" aria-controls="collapseStatements">
                            Statements ({{ narrative.source_statements.count }})
                        </button>
                    </h2>
                    <div id="collapseStatements" class="accordion-collapse collapse" aria-labelledby="headingStatements" data-bs-parent="#evidenceAccordion">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectStatementsModal">+</button>
                            </div>
                            <div class="list-group" id="statements-display-list">
                                {% for stmt in narrative.source_statements.all %}
                                    <a href="#" class="list-group-item list-group-item-action" data-statement-id="{{ stmt.pk }}">
                                        "{{ stmt.text|truncatewords:20 }}"
                                    </a>
                                {% empty %}
                                    <div class="list-group-item text-muted">No statements linked.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Events Card -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingEvents">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEvents" aria-expanded="false" aria-controls="collapseEvents">
                            Events ({{ narrative.evenements.count }})
                        </button>
                    </h2>
                    <div id="collapseEvents" class="accordion-collapse collapse" aria-labelledby="headingEvents" data-bs-parent="#evidenceAccordion">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectEventsModal">+</button>
                            </div>
                            <div class="list-group" id="events-display-list">
                                {% for event in narrative.evenements.all %}
                                    <a href="{% url 'events:detail' event.pk %}" class="list-group-item list-group-item-action">
                                        {{ event.date|date:"Y-m-d" }}: {{ event.explanation|truncatewords:10 }}
                                    </a>
                                {% empty %}
                                    <div class="list-group-item text-muted">No events linked.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email Quotes Card -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingEmailQuotes">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmailQuotes" aria-expanded="false" aria-controls="collapseEmailQuotes">
                            Email Quotes ({{ narrative.citations_courriel.count }})
                        </button>
                    </h2>
                    <div id="collapseEmailQuotes" class="accordion-collapse collapse" aria-labelledby="headingEmailQuotes" data-bs-parent="#evidenceAccordion">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectEmailQuotesModal">+</button>
                            </div>
                            <div class="list-group" id="email-quotes-display-list">
                                {% for quote in narrative.citations_courriel.all %}
                                    <a href="{{ quote.email.get_absolute_url }}" class="list-group-item list-group-item-action" data-quote-id="{{ quote.pk }}">
                                        "{{ quote.quote_text|truncatewords:10 }}"
                                    </a>
                                {% empty %}
                                    <div class="list-group-item text-muted">No email quotes linked.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PDF Quotes Card -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPdfQuotes">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePdfQuotes" aria-expanded="false" aria-controls="collapsePdfQuotes">
                            PDF Quotes ({{ narrative.citations_pdf.count }})
                        </button>
                    </h2>
                    <div id="collapsePdfQuotes" class="accordion-collapse collapse" aria-labelledby="headingPdfQuotes" data-bs-parent="#evidenceAccordion">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectPdfQuotesModal">+</button>
                            </div>
                            <div class="list-group" id="pdf-quotes-display-list">
                                {% for quote in narrative.citations_pdf.all %}
                                    <a href="{{ quote.pdf_document.get_absolute_url }}" class="list-group-item list-group-item-action" data-quote-id="{{ quote.pk }}">
                                        "{{ quote.quote_text|truncatewords:10 }}" (p. {{ quote.page_number }})
                                    </a>
                                {% empty %}
                                    <div class="list-group-item text-muted">No PDF quotes linked.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Photo Documents Card -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPhotoDocs">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePhotoDocs" aria-expanded="false" aria-controls="collapsePhotoDocs">
                            Photo Documents ({{ narrative.photo_documents.count }})
                        </button>
                    </h2>
                    <div id="collapsePhotoDocs" class="accordion-collapse collapse" aria-labelledby="headingPhotoDocs" data-bs-parent="#evidenceAccordion">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-2">
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectPhotoDocumentsModal">+</button>
                            </div>
                            <div class="list-group" id="photo-documents-display-list">
                                {% for doc in narrative.photo_documents.all %}
                                    <a href="{% url 'photos:document_detail' doc.pk %}" class="list-group-item list-group-item-action">
                                        {{ doc.title|truncatewords:10 }}
                                    </a>
                                {% empty %}
                                    <div class="list-group-item text-muted">No photo documents linked.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="card-footer">
            <a href="{% url 'argument_manager:update' narrative.pk %}" class="btn btn-secondary">Edit</a>
            <a href="{% url 'argument_manager:delete' narrative.pk %}" class="btn btn-danger">Delete</a>
            <a href="{% url 'argument_manager:list' %}" class="btn btn-outline-secondary">Back to List</a>
        </div>
    </div>

    {% include 'argument_manager/_modals.html' %}
</div>
{% endblock %}

{% block extra_js %}
    {{ narrative_data_json|json_script:"narrative-data" }}
    <script>
        const narrativeData = JSON.parse(document.getElementById('narrative-data').textContent);
        window.narrativeData = narrativeData;
    </script>
    <script src="{% static 'tinymce/tinymce.min.js' %}"></script>
    <script src="{% static 'js/custom_inserter_plugin.js' %}"></script> 
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // View switcher logic
            document.getElementById('columnsView').addEventListener('change', function() {
                if (this.checked) {
                    const url = new URL(window.location.href);
                    url.searchParams.set('view', 'columns');
                    window.location.href = url.toString();
                }
            });
            
            // Summary editing logic
            const summaryContent = document.getElementById('summary-content');
            let isEditing = false;
            summaryContent.addEventListener('click', function () {
                if (isEditing) return;
                isEditing = true;
                tinymce.init({
                    target: summaryContent,
                    inline: true,
                    menubar: false,
                    plugins: 'advlist autolink lists table custom_inserter', 
                    toolbar: 'undo redo | bold italic underline | bullist numlist | custom_inserter | table', 
                    setup: function (editor) {
                        editor.on('init', () => editor.focus());
                        editor.on('blur', () => saveContent(editor));
                        editor.on('remove', () => isEditing = false);
                    }
                });
            });

            function saveContent(editor) {
                if (!editor.isDirty()) {
                    editor.destroy();
                    return;
                }
                const narrativeId = {{ narrative.pk }};
                const csrfToken = document.querySelector('[name=csrf-token]').content;
                fetch(`/arguments/${narrativeId}/ajax_update_summary/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ resume: editor.getContent() })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) alert('Error saving summary: ' + data.error);
                })
                .catch(error => console.error('Error:', error))
                .finally(() => editor.destroy());
            }
        });
    </script>
    {% include 'argument_manager/_event_selection_js.html' %}
    {% include 'argument_manager/_email_quote_selection_js.html' %}
    {% include 'argument_manager/_pdf_quote_selection_js.html' %}
    {% include 'argument_manager/_photo_document_selection_js.html' %}
    {% include 'argument_manager/_statement_selection_js.html' %}
{% endblock %}
