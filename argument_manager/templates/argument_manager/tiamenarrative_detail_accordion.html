{% extends 'base.html' %}
{% load static %}
{% load quote_filters %}

{% block title %}Narrative Details{% endblock %}

{% block content %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h3>{{ narrative.titre }}</h3>
                <small class="text-muted">{{ narrative.get_type_argument_display }}</small>
            </div>
            <a href="{% url 'argument_manager:affidavit_generator' narrative.pk %}" class="btn btn-primary">Generate Affidavit</a>
        </div>
        <div class="card-body">
            <!-- View switcher -->
            <div class="d-flex justify-content-end mb-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="viewType" id="columnsView" value="columns">
                    <label class="form-check-label" for="columnsView">Columns</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="viewType" id="accordionView" value="accordion" checked>
                    <label class="form-check-label" for="accordionView">Accordion</label>
                </div>
            </div>

            <p><strong>Summary:</strong></p>
            {# This is the static element that users will click to edit. #}
            <div id="summary-content" title="Click to edit" style="cursor:pointer;">{{ narrative.resume|safe }}</div>

            <hr>

            <h5>Targeted Claims (Allegations)</h5>
            <ul>
                {% for allegation, doc_pk in allegations_with_docs %}
                    <li>
                        {% if doc_pk %}
                            <a href="{% url 'document_manager:clean_detail_view' doc_pk %}?highlight={{ highlight_ids }}">{{ allegation.text }}</a>
                        {% else %}
                            {{ allegation.text }} (Not linked to a document)
                        {% endif %}
                    </li>
                {% empty %}
                    <li>No specific claims have been targeted yet.</li>
                {% endfor %}
            </ul>

            <hr>

            <h5>Supporting Evidence</h5>
            <div class="accordion" id="supportingEvidenceAccordion">
                {# Events Section #}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingEvents">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEvents" aria-expanded="true" aria-controls="collapseEvents">
                            Events
                        </button>
                    </h2>
                    <div id="collapseEvents" class="accordion-collapse collapse show" aria-labelledby="headingEvents" data-bs-parent="#supportingEvidenceAccordion">
                        <div class="accordion-body">
                            <button class="btn btn-sm btn-outline-primary mb-2" data-bs-toggle="modal" data-bs-target="#selectEventsModal">+</button>
                            <div class="list-group" id="events-display-list">
                                {% for event in narrative.evenements.all %}
                                    <a href="{% url 'events:detail' event.pk %}" class="list-group-item list-group-item-action">
                                        {{ event.date|date:"Y-m-d" }}: {{ event.explanation|truncatewords:10 }}
                                    </a>
                                {% empty %}
                                    <div class="list-group-item text-muted">No events linked.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {# Email Quotes Section #}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingEmailQuotes">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmailQuotes" aria-expanded="false" aria-controls="collapseEmailQuotes">
                            Email Quotes
                        </button>
                    </h2>
                    <div id="collapseEmailQuotes" class="accordion-collapse collapse" aria-labelledby="headingEmailQuotes" data-bs-parent="#supportingEvidenceAccordion">
                        <div class="accordion-body">
                            <button class="btn btn-sm btn-outline-primary mb-2" data-bs-toggle="modal" data-bs-target="#selectEmailQuotesModal">+</button>
                            <div class="list-group" id="email-quotes-display-list">
                                {% for quote in narrative.citations_courriel.all %}
                                    <a href="{{ quote.email.get_absolute_url }}" class="list-group-item list-group-item-action" data-quote-id="{{ quote.pk }}">
                                        "{{ quote.quote_text|truncatewords:10 }}"
                                    </a>
                                {% empty %}
                                    <div class="list-group-item text-muted">No email quotes linked.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {# PDF Quotes Section #}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPdfQuotes">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePdfQuotes" aria-expanded="false" aria-controls="collapsePdfQuotes">
                            PDF Quotes
                        </button>
                    </h2>
                    <div id="collapsePdfQuotes" class="accordion-collapse collapse" aria-labelledby="headingPdfQuotes" data-bs-parent="#supportingEvidenceAccordion">
                        <div class="accordion-body">
                            <button class="btn btn-sm btn-outline-primary mb-2" data-bs-toggle="modal" data-bs-target="#selectPdfQuotesModal">+</button>
                            <div class="list-group" id="pdf-quotes-display-list">
                                {% for quote in narrative.citations_pdf.all %}
                                    <a href="{{ quote.pdf_document.get_absolute_url }}" class="list-group-item list-group-item-action" data-quote-id="{{ quote.pk }}">
                                        "{{ quote.quote_text|truncatewords:10 }}" (p. {{ quote.page_number }})
                                    </a>
                                {% empty %}
                                    <div class="list-group-item text-muted">No PDF quotes linked.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {# Photo Documents Section #}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingPhotoDocuments">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePhotoDocuments" aria-expanded="false" aria-controls="collapsePhotoDocuments">
                            Photo Documents
                        </button>
                    </h2>
                    <div id="collapsePhotoDocuments" class="accordion-collapse collapse" aria-labelledby="headingPhotoDocuments" data-bs-parent="#supportingEvidenceAccordion">
                        <div class="accordion-body">
                            <button class="btn btn-sm btn-outline-primary mb-2" data-bs-toggle="modal" data-bs-target="#selectPhotoDocumentsModal">+</button>
                            <div class="list-group" id="photo-documents-display-list">
                                {% for doc in narrative.photo_documents.all %}
                                    <a href="{% url 'photos:document_detail' doc.pk %}" class="list-group-item list-group-item-action">
                                        {{ doc.title|truncatewords:10 }}
                                    </a>
                                {% empty %}
                                    <div class="list-group-item text-muted">No photo documents linked.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="card-footer">
            <a href="{% url 'argument_manager:update' narrative.pk %}" class="btn btn-secondary">Edit</a>
            <a href="{% url 'argument_manager:delete' narrative.pk %}" class="btn btn-danger">Delete</a>
            <a href="{% url 'argument_manager:list' %}" class="btn btn-outline-secondary">Back to List</a>
        </div>
    </div>

    <!-- MODALS -->
    {% include 'argument_manager/_modals.html' %}

{% endblock %}

{% block extra_js %}
    <script>
        // Data for our custom TinyMCE plugin
        window.narrativeData = {
            events: [
                {% for event in narrative.evenements.all %}
                    {
                        title: '{{ event.date|date:"Y-m-d" }}: {{ event.explanation|truncatewords:10|escapejs }}',
                        text: '{{ event.explanation|escapejs }}',
                        url: '{% url "events:detail" event.pk %}'
                    }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            emailQuotes: [
                {% for quote in narrative.citations_courriel.all %}
                    {
                        title: '{{ quote.quote_text|after_colon|truncatewords:10|escapejs }}',
                        text: '{{ quote.quote_text|escapejs }}',
                        url: '{% url "email_manager:thread_detail" quote.email.thread.pk %}'
                    }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            pdfQuotes: [
                {% for quote in narrative.citations_pdf.all %}
                    {
                        title: '{{ quote.quote_text|after_colon|truncatewords:10|escapejs }}',
                        text: '{{ quote.quote_text|escapejs }}',
                        url: '{% url "pdf_manager:pdf_detail" quote.pdf_document.pk %}'
                    }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        };
    </script>
    <script src="{% static 'tinymce/tinymce.min.js' %}"></script>
    <script src="{% static 'js/custom_inserter_plugin.js' %}"></script> 
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const summaryContent = document.getElementById('summary-content');
            let isEditing = false; // Flag to prevent re-initializing the editor on clicks within it.

            // 1. The Trigger: A click event on the static element.
            summaryContent.addEventListener('click', function () {
                if (isEditing) {
                    return;
                }
                isEditing = true;

                // 2. The Transformation: Initialize TinyMCE in inline mode on the div.
                tinymce.init({
                    target: summaryContent,
                    inline: true,
                    menubar: false,
                    plugins: 'advlist autolink lists table custom_inserter', 
                    toolbar: 'undo redo | bold italic underline | bullist numlist | custom_inserter | table', 
                    setup: function (editor) {
                        // Focus the editor as soon as it's ready.
                        editor.on('init', function () {
                            editor.focus();
                        });

                        // 3. The Save Event: Triggered when the editor loses focus (blur).
                        editor.on('blur', function () {
                            saveContent(editor);
                        });
                        
                        // When the editor is removed, reset the flag to allow editing again.
                        editor.on('remove', function() {
                            isEditing = false;
                        });
                    }
                });
            });

            function saveContent(editor) {
                const newContent = editor.getContent();
                
                // Only save if content has actually changed.
                if (!editor.isDirty()) {
                    editor.destroy(); // Still destroy to revert to a static div.
                    return;
                }

                const narrativeId = {{ narrative.pk }};
                const csrfToken = document.querySelector('[name=csrf-token]').content;

                // 4. The Server Communication: Send the new content via Fetch API.
                fetch(`/arguments/${narrativeId}/ajax_update_summary/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ resume: newContent })
                })
                .then(response => response.json())
                .then(data => {
                    // 5. The Confirmation: On success, the editor is destroyed, and the div's
                    // content is already updated. If there's an error, we alert the user.
                    if (data.success) {
                        // Content is visually updated by TinyMCE, no action needed here.
                    } else {
                        alert('Error saving summary: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An unexpected error occurred.');
                })
                .finally(() => {
                    // This ensures the editor is removed and the div reverts to static,
                    // completing the "disappear on blur" effect.
                    editor.destroy();
                });
            }

            const columnsViewRadio = document.getElementById('columnsView');
            columnsViewRadio.addEventListener('change', function() {
                if (this.checked) {
                    const url = new URL(window.location.href);
                    url.searchParams.delete('view');
                    window.location.href = url.toString();
                }
            });
        });
    </script>
    {# Includes the JavaScript for modal features #}
    {% include 'argument_manager/_event_selection_js.html' %}
    {% include 'argument_manager/_email_quote_selection_js.html' %}
    {% include 'argument_manager/_pdf_quote_selection_js.html' %}
    {% include 'argument_manager/_photo_document_selection_js.html' %}
{% endblock %}
