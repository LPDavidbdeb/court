{% extends 'base.html' %}
{% load static %}

{% block title %}Narrative Details (Accordion View){% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h3>{{ narrative.titre }}</h3>
                <small class="text-muted">{{ narrative.get_type_argument_display }}</small>
            </div>
            <a href="{% url 'argument_manager:affidavit_generator' narrative.pk %}" class="btn btn-primary">Generate Affidavit</a>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-end mb-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="viewType" id="columnsView" value="columns">
                    <label class="form-check-label" for="columnsView">Columns</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="viewType" id="accordionView" value="accordion" checked>
                    <label class="form-check-label" for="accordionView">Accordion</label>
                </div>
            </div>

            <p><strong>Summary:</strong></p>
            <div id="summary-content" class="p-3 bg-light rounded" title="Click to edit" style="cursor:pointer;">{{ narrative.resume|safe }}</div>

            <hr>

            <div class="accordion" id="argumentAccordion">
                {% for argument in arguments %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-{{ argument.id }}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ argument.id }}" aria-expanded="true" aria-controls="collapse-{{ argument.id }}">
                            {{ argument.title }}
                        </button>
                    </h2>
                    <div id="collapse-{{ argument.id }}" class="accordion-collapse collapse show" aria-labelledby="heading-{{ argument.id }}" data-bs-parent="#argumentAccordion">
                        <div class="accordion-body">
                            <div class="legal-block mb-5">
                                <div class="section-declaration">
                                    <h4>1. Déclaration faite sous serment :</h4>
                                    <div class="content">
                                        {{ argument.text_declaration|safe }}
                                        
                                        <ul>
                                        {% for lie in argument.targeted_statements.all %}
                                            <li class="text-danger">"{{ lie.text }}" ({{ lie.document.title }})</li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                <div class="section-proof">
                                    <h4>2. Preuve de la fausseté de la déclaration :</h4>
                                    <div class="content">
                                        {{ argument.text_proof|safe }}
                                    </div>
                                </div>

                                <div class="section-mens-rea">
                                    <h4>3. Connaissance de la fausseté (Mens Rea) :</h4>
                                    <div class="content">
                                        {{ argument.text_mens_rea|safe }}
                                    </div>
                                </div>

                                <div class="section-intent">
                                    <h4>4. Intention de tromper le tribunal :</h4>
                                    <div class="content">
                                        {{ argument.text_intent|safe }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-info">
                    No arguments have been created for this narrative yet.
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="card-footer">
            <a href="{% url 'argument_manager:update' narrative.pk %}" class="btn btn-secondary">Edit</a>
            <a href="{% url 'argument_manager:delete' narrative.pk %}" class="btn btn-danger">Delete</a>
            <a href="{% url 'argument_manager:list' %}" class="btn btn-outline-secondary">Back to List</a>
        </div>
    </div>

    {% include 'argument_manager/_modals.html' %}
</div>
{% endblock %}

{% block extra_js %}
    {{ narrative_data_json|json_script:"narrative-data" }}
    <script>
        const narrativeData = JSON.parse(document.getElementById('narrative-data').textContent);
        window.narrativeData = narrativeData;
    </script>
    <script src="{% static 'tinymce/tinymce.min.js' %}"></script>
    <script src="{% static 'js/custom_inserter_plugin.js' %}"></script> 
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // View switcher logic
            document.getElementById('columnsView').addEventListener('change', function() {
                if (this.checked) {
                    const url = new URL(window.location.href);
                    url.searchParams.set('view', 'columns');
                    window.location.href = url.toString();
                }
            });
            
            // Summary editing logic
            const summaryContent = document.getElementById('summary-content');
            let isEditing = false;
            summaryContent.addEventListener('click', function () {
                if (isEditing) return;
                isEditing = true;
                tinymce.init({
                    target: summaryContent,
                    inline: true,
                    menubar: false,
                    plugins: 'advlist autolink lists table custom_inserter', 
                    toolbar: 'undo redo | bold italic underline | bullist numlist | custom_inserter | table', 
                    setup: function (editor) {
                        editor.on('init', () => editor.focus());
                        editor.on('blur', () => saveContent(editor));
                        editor.on('remove', () => isEditing = false);
                    }
                });
            });

            function saveContent(editor) {
                if (!editor.isDirty()) {
                    editor.destroy();
                    return;
                }
                const narrativeId = {{ narrative.pk }};
                const csrfToken = document.querySelector('[name=csrf-token]').content;
                fetch(`/arguments/${narrativeId}/ajax_update_summary/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ resume: editor.getContent() })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) alert('Error saving summary: ' + data.error);
                })
                .catch(error => console.error('Error:', error))
                .finally(() => editor.destroy());
            }
        });
    </script>
    {% include 'argument_manager/_event_selection_js.html' %}
    {% include 'argument_manager/_email_quote_selection_js.html' %}
    {% include 'argument_manager/_pdf_quote_selection_js.html' %}
    {% include 'argument_manager/_photo_document_selection_js.html' %}
    {% include 'argument_manager/_statement_selection_js.html' %}
{% endblock %}
