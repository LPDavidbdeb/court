<script>
document.addEventListener('DOMContentLoaded', function() {
    const pdfQuotesModal = document.getElementById('selectPdfQuotesModal');
    const pdfQuotesModalBody = document.getElementById('pdf-quotes-modal-body');
    const savePdfQuoteChangesBtn = document.getElementById('save-pdf-quote-changes-btn');
    const pdfQuotesDisplayList = document.getElementById('pdf-quotes-display-list');
    const narrativeId = {{ narrative.pk }}; // CORRECTED
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    pdfQuotesModal.addEventListener('show.bs.modal', function () {
        pdfQuotesModalBody.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        
        // CORRECTED: Use dynamic URL and fetch data, not pre-rendered HTML
        fetch(`/arguments/ajax/get-pdf-quotes-list/`)
            .then(response => response.text())
            .then(html => {
                pdfQuotesModalBody.innerHTML = html;
                // Since the HTML is pre-rendered, we need to find out which ones are associated
                // This is less efficient. A better approach would be an API endpoint returning JSON.
                // For now, we will work with what we have.
                const associatedQuoteIds = Array.from(pdfQuotesDisplayList.querySelectorAll('a')).map(a => a.dataset.quoteId);
                associatedQuoteIds.forEach(id => {
                    const checkbox = pdfQuotesModalBody.querySelector(`input[value="${id}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching PDF quotes:', error);
                pdfQuotesModalBody.innerHTML = '<p class="text-danger">Could not load quotes.</p>';
            });
    });

    savePdfQuoteChangesBtn.addEventListener('click', function() {
        const selectedIds = Array.from(pdfQuotesModalBody.querySelectorAll('input[type="checkbox"]:checked'))
                                 .map(input => input.value);

        // CORRECTED: Use AJAX to save the changes
        fetch(`/arguments/${narrativeId}/ajax_update_narrative_pdf_quotes/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ quote_ids: selectedIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let listHtml = '';
                if (data.quotes && data.quotes.length > 0) {
                    data.quotes.forEach(quote => {
                        listHtml += `
                            <a href="${quote.parent_url}" class="list-group-item list-group-item-action" data-quote-id="${quote.pk}">
                                "${quote.text.substring(0, 50)}..." (p. ${quote.page})
                            </a>
                        `;
                    });
                } else {
                    listHtml = '<div class="list-group-item text-muted">No PDF quotes linked.</div>';
                }
                pdfQuotesDisplayList.innerHTML = listHtml;

                const modal = bootstrap.Modal.getInstance(pdfQuotesModal);
                modal.hide();
            } else {
                alert('Error saving changes: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error saving PDF quotes:', error);
            alert('An unexpected error occurred while saving.');
        });
    });
});
</script>
