<script>
document.addEventListener('DOMContentLoaded', function() {
    const pdfQuotesModal = document.getElementById('selectPdfQuotesModal');
    const pdfQuotesModalBody = document.getElementById('pdf-quotes-modal-body');
    const savePdfQuoteChangesBtn = document.getElementById('save-pdf-quote-changes-btn');
    const pdfQuoteList = document.getElementById('pdf-quote-list');
    const hiddenInput = document.getElementById('id_selected_pdf_quotes');
    const narrativeId = {{ form.instance.pk }};

    pdfQuotesModal.addEventListener('show.bs.modal', function () {
        // Fetch the list of PDF quotes from the server
        fetch(`/arguments/ajax/get-pdf-quotes-list/`)
            .then(response => response.text()) // We expect HTML from this view
            .then(html => {
                pdfQuotesModalBody.innerHTML = html;

                // Now that the content is loaded, pre-check the boxes for already-associated quotes
                const currentlySelectedIds = hiddenInput.value.split(',').filter(Boolean); // Get IDs from the hidden input
                currentlySelectedIds.forEach(id => {
                    const checkbox = pdfQuotesModalBody.querySelector(`input[type="checkbox"][value="${id}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching PDF quotes:', error);
                pdfQuotesModalBody.innerHTML = '<p class="text-danger">Could not load quotes.</p>';
            });
    });

    savePdfQuoteChangesBtn.addEventListener('click', function() {
        const selectedCheckboxes = pdfQuotesModalBody.querySelectorAll('input[type="checkbox"]:checked');
        const selectedIds = Array.from(selectedCheckboxes).map(input => input.value);

        // Update the hidden input that will be submitted with the form
        hiddenInput.value = selectedIds.join(',');

        // Update the visible list on the main form
        let listHtml = '';
        selectedCheckboxes.forEach(checkbox => {
            // Find the label text associated with the checkbox
            const label = checkbox.closest('li').querySelector('label').textContent;
            listHtml += `<li class="list-group-item" data-quote-id="${checkbox.value}">${label}</li>`;
        });
        pdfQuoteList.innerHTML = listHtml;

        // Close the modal
        const modal = bootstrap.Modal.getInstance(pdfQuotesModal);
        modal.hide();
    });
});
</script>
