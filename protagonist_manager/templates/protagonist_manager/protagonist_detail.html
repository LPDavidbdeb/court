{% extends "base.html" %}

{% block title %}{{ protagonist.get_full_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Main Content -->
        <div class="col-md-8">
            <h1>{{ protagonist.get_full_name }}</h1>
            <div class="form-group">
                <label for="role-input"><strong>Role:</strong></label>
                <input type="text" id="role-input" class="form-control" value="{{ protagonist.role }}" data-protagonist-id="{{ protagonist.pk }}">
                <small id="role-status" class="form-text text-muted"></small>
            </div>
            
            <h3 class="mt-4">Emails</h3>
            <ul>
                {% for email in protagonist.emails.all %}
                    <li>{{ email.email_address }}</li>
                {% empty %}
                    <li>No email addresses found.</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Side Panel for Merging -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    Merge Protagonist
                </div>
                <div class="card-body">
                    <p>Merge this protagonist with another. All associated data will be moved to the selected protagonist, and this one will be deleted.</p>
                    <form action="{% url 'protagonist_manager:merge_protagonist' %}" method="post" onsubmit="return confirm('Are you sure you want to merge these protagonists? This action cannot be undone.');">
                        {% csrf_token %}
                        <input type="hidden" name="original_protagonist" value="{{ protagonist.pk }}">
                        
                        <div class="form-group">
                            <label for="duplicate-select">Select protagonist to merge into this one:</label>
                            <select name="duplicate_protagonist" id="duplicate-select" class="form-control">
                                <option value="">--- Select a protagonist ---</option>
                                {% for candidate in merge_candidates %}
                                    <option value="{{ candidate.pk }}">{{ candidate.get_full_name }} ({{ candidate.role }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-danger mt-3">Merge</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const roleInput = $('#role-input');
    const roleStatus = $('#role-status');
    let originalRole = roleInput.val();

    roleInput.on('blur', function() {
        const newRole = $(this).val();
        const protagonistId = $(this).data('protagonist-id');

        // Only send request if the value has changed
        if (newRole !== originalRole) {
            roleStatus.text('Saving...').removeClass('text-danger').addClass('text-muted');

            fetch("{% url 'protagonist_manager:update_protagonist_role' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    protagonist_id: protagonistId,
                    role: newRole
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    originalRole = newRole; // Update original role on success
                    roleStatus.text('Saved!').delay(2000).fadeOut('slow', function() { $(this).text('').show(); });
                } else {
                    roleStatus.text('Error: ' + data.message).addClass('text-danger');
                    roleInput.val(originalRole); // Revert to original value on error
                }
            })
            .catch(error => {
                console.error('Error:', error);
                roleStatus.text('An unexpected error occurred.').addClass('text-danger');
                roleInput.val(originalRole); // Revert on error
            });
        }
    });
});
</script>
{% endblock %}
